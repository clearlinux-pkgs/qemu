From: 	Samuel Thibault
Subject: 	[Qemu-devel] [PULL 65/65] slirp: check data length while emulating ident function
Date: 	Mon, 14 Jan 2019 23:53:06 +0100

From: Prasad J Pandit <address@hidden>

While emulating identification protocol, tcp_emu() does not check
available space in the 'sc_rcv->sb_data' buffer. It could lead to
heap buffer overflow issue. Add check to avoid it.

Reported-by: Kira <address@hidden>
Signed-off-by: Prasad J Pandit <address@hidden>
Signed-off-by: Samuel Thibault <address@hidden>
---
 slirp/tcp_subr.c | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/slirp/tcp_subr.c b/slirp/tcp_subr.c
index fa61349c..def4b857 100644
--- a/slirp/tcp_subr.c
+++ b/slirp/tcp_subr.c
@@ -1,3 +1,4 @@
+
 /*
  * Copyright (c) 1982, 1986, 1988, 1990, 1993
  *	The Regents of the University of California.  All rights reserved.
@@ -635,6 +636,11 @@ tcp_emu(struct socket *so, struct mbuf *m)
 			socklen_t addrlen = sizeof(struct sockaddr_in);
 			struct sbuf *so_rcv = &so->so_rcv;
 
+			if (m->m_len > so_rcv->sb_datalen -
+					(so_rcv->sb_wptr - so_rcv->sb_data)) {
+				return 1;
+			}
+
 			memcpy(so_rcv->sb_wptr, m->m_data, m->m_len);
 			so_rcv->sb_wptr += m->m_len;
 			so_rcv->sb_rptr += m->m_len;
